sudo: required
dist: trusty
language: cpp

cache:
  directories:
    - $HOME/.conan

addons:
  apt:
    sources:
      - sourceline: "deb http://apt.llvm.org/precise/ llvm-toolchain-precise-3.8 main"
        key_url : "http://apt.llvm.org/llvm-snapshot.gpg.key"
      - ubuntu-toolchain-r-test
      - george-edison55-precise-backports
    packages:
      - g++-5
      - clang-3.8
      - cmake
      - cmake-data

compiler:
  - gcc
  - clang

os:
  - linux
  - osx
  
osx_image: xcode8

env:
  - build_type=debug options="-D stlab_testing=ON"
  - build_type=release options="-D stlab_testing=ON"

matrix:
  include:
    - os: linux
      compiler: gcc
      env:
        build_type=debug
        coverage=TRUE
        options="-D stlab_testing=ON -D coverage=ON"
      packages:
        - lcov
      after_success:
        - cd build
        - bash <(curl -s https://codecov.io/bash) -X fix

    - os: linux
      compiler: clang
      env:
        build_type=debug
        flags="-fsanitize=address;-fno-omit-frame-pointer;"
        options="-D stlab_testing=ON"
        
    - os: linux
      compiler: clang
      env:
        build_type=debug
        flags="-fsanitize=undefined;-fno-omit-frame-pointer;"
        options="-D stlab_testing=ON"
        
    - os: linux
      compiler: clang
      env:
        build_type=debug
        TSAN_OPTIONS="suppressions=${TRAVIS_BUILD_DIR}/test/sanitizer_suppressions"
        flags="-fsanitize=thread;-fno-omit-frame-pointer;"
        options="-D stlab_testing=ON"

    - os: linux
      compiler: clang
      env:
        build_type=debug
        options="-D stlab_testing=ON"
      before_install:
        - pip install conan
        - echo -n | openssl s_client -connect scan.coverity.com:443 | sed -ne '/-BEGIN CERTIFICATE-/,/-END CERTIFICATE-/p' | sudo tee -a /etc/ssl/certs/ca-
      addons:
        apt:
          sources:
            - sourceline: "deb http://apt.llvm.org/precise/ llvm-toolchain-precise-3.8 main"
              key_url : "http://apt.llvm.org/llvm-snapshot.gpg.key"
            - ubuntu-toolchain-r-test
            - george-edison55-precise-backports
          packages:
            - g++-5
            - clang-3.8
            - cmake
            - cmake-data
        coverity_scan:
          project:
            name: "stlab/libraries"
            description: "Build submitted via Travis CI"
          notification_email: fosterb@gmail.com
          build_command_prepend: ""
          build_command: ".travis/build.sh"
          branch_pattern: coverity

  exclude:
    - os: osx
      compiler: gcc

branches:
  except: /pr\/.*/
  
before_install:
  - pip install conan
  
script:
  - .travis/build.sh
  
notifications:
  recipients:
    - felix@petriconi.net
  email:
    on_success: change
    on_failure: always
  slack:
    on_success: change
    on_failure: always
    rooms:
      secure: l1jEwm9Jibm7U/Ytlq5cV9Br6EvGFCWw2bi7syuVt8Zk/8DQjrJvTyZ/FMRxJ0SB/McKCOHQBrgsoUyJkz3Tyca3hQwMUjiF8+7DdDKX91p5Vo5QgDKAcx48Ye2Ux07Bkn1nyrK4CE9S/pYKlSF+GlwNUL0AFnoJYlujVaKf75D6qhi/4MF8M2Jl+1k5r5M8nVjc/anPEoOzq1QdnDvBd4P/H9uIs/CtEVzSRxsqLhBDTW/l8d6QBPVSX75eHgAFiTYiCD5eCBzOoGWq7lvJfLEoDZDkgXN4ZO7sb9MJZzUFE2+gPi2E+vZuDNz001rJEbJCLVTCKEF4S6gNNBgfUoQmE+QmHb83Z1H9UkVMZH17pNpuo+5iKB+CbG5GG5RMROZyiUDcHeUVX9pcCE1R+RbTvpaXWA9PbscWHj2rv9cu6QslgtH8HOGHzmSXXRbF+oO41+0gF1NJrMHUqY53Y9ky4tWnHYsDdqAuoiO+TbEGwgNS9iW21VIfwSkcCD+cM7ci+F5gkNbGY9XIOIrorIeYDvrkNgc30oErGA6qtdV4NF4iRj+BkuwPmyS4vd33HXFfZMiqEGcENy/BsqigrxnOQQ1LUca9m29bPc4/gjZcsYqgow6/bPK8/cQpOs1Wk7GZ3VtL3NluZcPeq3BSzUqY4sUH09He8lsfrntug4A=
